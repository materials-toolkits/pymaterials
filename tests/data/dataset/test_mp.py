import pytest
from pymatgen.core.structure import Structure
from pymatgen.io.vasp import Poscar
from pymatgen.analysis.structure_matcher import StructureMatcher

from materials_toolkit.data.datasets import MaterialsProject
from materials_toolkit.data import StructureData

import os


@pytest.fixture(scope="session")
def mp_tmp_path(tmp_path_factory):
    path = tmp_path_factory.mktemp("mp")

    return path


def compare_data_poscar(data: StructureData, poscar: str) -> bool:
    matcher = StructureMatcher()
    struct1 = Structure(lattice=data.cell[0], species=data.z, coords=data.pos)
    struct2 = Poscar.from_str(poscar).structure
    return matcher.fit(struct1, struct2)


@pytest.mark.timeout(30)
def test_materials_project_dataset(mp_tmp_path):
    dataset = MaterialsProject(mp_tmp_path)

    assert len(dataset) == 133420

    assert compare_data_poscar(
        dataset[0],
        """K4 Sn8
    1.0
    3.2630416376333375   -5.6517539035936935    0.0000000000000000
    3.2630416376333375    5.6517539035936935    0.0000000000000000
    0.0000000000000000    0.0000000000000000   10.1636446700000000
    K Sn
    4 8
    direct
    0.3333333333333333    0.6666666666666666    0.4328038600000000 K
    0.6666666666666667    0.3333333333333334    0.5671961400000000 K
    0.6666666666666667    0.3333333333333333    0.9328038600000000 K
    0.3333333333333333    0.6666666666666667    0.0671961400000000 K
    0.0000000000000000    0.0000000000000000    0.5000000000000000 Sn
    0.0000000000000000    0.0000000000000000    0.0000000000000000 Sn
    0.8323710350000000    0.1676289650000000    0.2500000000000000 Sn
    0.8323710350000000    0.6647420700000000    0.2500000000000000 Sn
    0.3352579300000000    0.1676289650000000    0.2500000000000000 Sn
    0.1676289650000000    0.8323710350000000    0.7500000000000000 Sn
    0.1676289650000000    0.3352579300000000    0.7500000000000000 Sn
    0.6647420700000000    0.8323710350000000    0.7500000000000000 Sn""",
    )

    assert compare_data_poscar(
        dataset[99610],
        """Sm6 Al2
    1.0
    3.5093995329377692   -6.0784582951067039    0.0000000000000000
    3.5093995329377692    6.0784582951067039    0.0000000000000000
    0.0000000000000000    0.0000000000000000    5.2985976299999997
    Sm Al
    6 2
    direct
    0.8218628600000000    0.1781371400000000    0.7500000000000000 Sm
    0.3562742800000001    0.1781371400000000    0.7500000000000000 Sm
    0.8218628600000000    0.6437257199999999    0.7500000000000000 Sm
    0.1781371400000000    0.8218628600000000    0.2500000000000000 Sm
    0.6437257199999999    0.8218628600000000    0.2500000000000000 Sm
    0.1781371400000000    0.3562742800000001    0.2500000000000000 Sm
    0.6666666666666666    0.3333333333333333    0.2500000000000000 Al
    0.3333333333333334    0.6666666666666667    0.7500000000000000 Al""",
    )
    assert compare_data_poscar(
        dataset[106281],
        """Er1 Cu1 Si1
    1.0
    2.0567114553190247   -3.5623287371214771    0.0000000000000000
    2.0567114553190247    3.5623287371214771    0.0000000000000000
    0.0000000000000000    0.0000000000000000    3.6828069999999999
    Er Cu Si
    1 1 1
    direct
    0.6666666666666666    0.3333333333333333    0.0000000000000000 Er3+
    0.0000000000000000    0.0000000000000000    0.5000000000000000 Cu+
    0.3333333333333333    0.6666666666666666    0.5000000000000000 Si4-""",
    )
    assert compare_data_poscar(
        dataset[113653],
        """Cr8 Pb40 O64
    1.0
    0.0000000000000000   11.9798080000000002    0.0000000000000000
    11.9873110000000000    0.0000000000000000    0.0000000000000000
    0.0000000000000000   -0.2899969999999978  -15.1467440000000018
    Cr Pb O
    8 40 64
    direct
    0.1578720000000000    0.3911279999999999    0.4265660000000000 Cr6+
    0.6578720000000000    0.1088720000000001    0.4265660000000000 Cr6+
    0.8421280000000000    0.6088720000000001    0.5734340000000000 Cr6+
    0.6503260000000000    0.0977490000000000    0.9291580000000000 Cr6+
    0.1503260000000000    0.4022510000000000    0.9291580000000000 Cr6+
    0.8496740000000000    0.5977489999999999    0.0708420000000000 Cr6+
    0.3421280000000000    0.8911279999999999    0.5734340000000000 Cr6+
    0.3496740000000000    0.9022510000000000    0.0708420000000000 Cr6+
    0.3903610000000000    0.5867190000000000    0.8109670000000000 Pb2+
    0.1164780000000000    0.0539390000000000    0.9373000000000000 Pb2+
    0.1083020000000000    0.7606020000000000    0.1904960000000000 Pb2+
    0.6096390000000000    0.4132810000000000    0.1890330000000000 Pb2+
    0.8624840000000000    0.5815920000000000    0.8098980000000000 Pb2+
    0.0990140000000000    0.7390970000000000    0.9376630000000000 Pb2+
    0.3725990000000000    0.9186480000000000    0.3258630000000000 Pb2+
    0.4009860000000000    0.2390970000000000    0.0623370000000000 Pb2+
    0.3624840000000000    0.9184080000000000    0.8098980000000000 Pb2+
    0.1078920000000000    0.0692880000000000    0.4397280000000000 Pb2+
    0.6164779999999999    0.4460610000000000    0.9373000000000000 Pb2+
    0.3921080000000000    0.5692880000000000    0.5602720000000000 Pb2+
    0.8928420000000000    0.9125060000000000    0.3108770000000000 Pb2+
    0.8835220000000000    0.9460610000000000    0.0627000000000000 Pb2+
    0.1096390000000000    0.0867190000000000    0.1890330000000000 Pb2+
    0.3928420000000000    0.5874940000000000    0.3108770000000000 Pb2+
    0.8903610000000000    0.9132810000000000    0.8109670000000000 Pb2+
    0.1108460000000000    0.7542360000000000    0.7062180000000000 Pb2+
    0.1131120000000000    0.7444130000000000    0.4248920000000000 Pb2+
    0.6083020000000001    0.7393980000000000    0.1904960000000000 Pb2+
    0.1375160000000000    0.4184080000000000    0.1901020000000000 Pb2+
    0.8725990000000001    0.5813520000000000    0.3258630000000000 Pb2+
    0.6078920000000001    0.4307120000000000    0.4397280000000000 Pb2+
    0.8891540000000000    0.2457640000000000    0.2937820000000000 Pb2+
    0.8868880000000000    0.2555870000000000    0.5751080000000000 Pb2+
    0.6375160000000000    0.0815920000000000    0.1901020000000000 Pb2+
    0.3916980000000000    0.2606020000000000    0.8095040000000000 Pb2+
    0.3891540000000000    0.2542360000000000    0.2937820000000000 Pb2+
    0.8921080000000000    0.9307120000000000    0.5602720000000000 Pb2+
    0.1071580000000000    0.0874940000000000    0.6891230000000000 Pb2+
    0.8916980000000000    0.2393980000000000    0.8095040000000000 Pb2+
    0.5990139999999999    0.7609030000000000    0.9376630000000000 Pb2+
    0.6071580000000000    0.4125060000000000    0.6891230000000000 Pb2+
    0.6274010000000000    0.0813520000000000    0.6741370000000000 Pb2+
    0.6108460000000000    0.7457640000000000    0.7062180000000000 Pb2+
    0.3868880000000000    0.2444130000000000    0.5751080000000000 Pb2+
    0.3835220000000000    0.5539390000000000    0.0627000000000000 Pb2+
    0.9009860000000000    0.2609030000000000    0.0623370000000000 Pb2+
    0.1274010000000000    0.4186480000000000    0.6741370000000000 Pb2+
    0.6131120000000001    0.7555870000000000    0.4248920000000000 Pb2+
    0.2908400000000000    0.4006879999999999    0.9284610000000000 O2-
    0.6519190000000000    0.2030170000000000    0.3444450000000000 O2-
    0.5056700000000000    0.3998380000000000    0.0541760000000000 O2-
    0.5910050000000000    0.9951280000000000    0.3932350000000000 O2-
    0.6115410000000000    0.0552070000000000    0.0291750000000000 O2-
    0.0187790000000000    0.2750159999999999    0.1818419999999999 O2-
    0.2922979999999999    0.4214500000000000    0.4458050000000000 O2-
    0.7091600000000000    0.5993120000000001    0.0715390000000000 O2-
    0.1020280000000000    0.2741960000000000    0.9095750000000000 O2-
    0.9957760000000000    0.0811100000000000    0.8155430000000000 O2-
    0.7098100000000001    0.6745760000000000    0.3105230000000000 O2-
    0.7012820000000000    0.6772190000000000    0.8286190000000000 O2-
    0.2987180000000000    0.3227810000000000    0.1713810000000000 O2-
    0.0099190000000000    0.9114350000000000    0.6855390000000000 O2-
    0.1049710000000000    0.4875740000000000    0.8488690000000000 O2-
    0.2098100000000001    0.8254240000000000    0.3105230000000000 O2-
    0.4812210000000000    0.7750159999999999    0.8181580000000001 O2-
    0.6037080000000000    0.1636060000000000    0.5185070000000001 O2-
    0.0136720000000000    0.2726720000000000    0.6929770000000000 O2-
    0.4957760000000000    0.4188900000000000    0.8155430000000000 O2-
    0.6049709999999999    0.0124260000000000    0.8488690000000000 O2-
    0.9089950000000000    0.4951280000000000    0.6067650000000000 O2-
    0.7922979999999999    0.0785500000000000    0.4458050000000000 O2-
    0.1115410000000000    0.4447930000000000    0.0291750000000000 O2-
    0.1037080000000000    0.3363940000000000    0.5185070000000001 O2-
    0.8950290000000000    0.5124260000000000    0.1511310000000000 O2-
    0.4942450000000000    0.4047290000000000    0.5601849999999999 O2-
    0.4900810000000000    0.4114350000000000    0.3144610000000000 O2-
    0.0042240000000000    0.9188900000000000    0.1844570000000000 O2-
    0.8962920000000000    0.6636060000000001    0.4814929999999999 O2-
    0.3480810000000000    0.7969830000000000    0.6555550000000000 O2-
    0.2091600000000000    0.9006879999999999    0.0715390000000000 O2-
    0.5187789999999999    0.2249840000000001    0.1818419999999999 O2-
    0.7901899999999999    0.1745760000000000    0.6894770000000000 O2-
    0.7908400000000000    0.0993120000000001    0.9284610000000000 O2-
    0.3962920000000000    0.8363940000000000    0.4814929999999999 O2-
    0.9812210000000000    0.7249840000000001    0.8181580000000001 O2-
    0.8480810000000000    0.7030170000000000    0.6555550000000000 O2-
    0.3979720000000000    0.7741959999999999    0.0904250000000000 O2-
    0.2012820000000000    0.8227810000000000    0.8286190000000000 O2-
    0.2077020000000001    0.9214500000000001    0.5541950000000000 O2-
    0.9863280000000000    0.7273280000000000    0.3070230000000000 O2-
    0.4089950000000000    0.0048720000000000    0.6067650000000000 O2-
    0.5057550000000000    0.5952710000000000    0.4398150000000001 O2-
    0.9900810000000000    0.0885650000000000    0.3144610000000000 O2-
    0.0910050000000000    0.5048720000000000    0.3932350000000000 O2-
    0.3950290000000000    0.9875740000000000    0.1511310000000000 O2-
    0.2901899999999999    0.3254240000000000    0.6894770000000000 O2-
    0.8979720000000000    0.7258040000000000    0.0904250000000000 O2-
    0.7987180000000000    0.1772190000000000    0.1713810000000000 O2-
    0.1519190000000000    0.2969830000000000    0.3444450000000000 O2-
    0.5042240000000000    0.5811100000000000    0.1844570000000000 O2-
    0.5099190000000000    0.5885650000000000    0.6855390000000000 O2-
    0.9942450000000000    0.0952710000000000    0.5601849999999999 O2-
    0.6020280000000000    0.2258040000000000    0.9095750000000000 O2-
    0.7077020000000001    0.5785500000000000    0.5541950000000000 O2-
    0.8884590000000000    0.5552070000000000    0.9708250000000000 O2-
    0.4943300000000000    0.6001620000000000    0.9458240000000000 O2-
    0.9943300000000000    0.8998379999999999    0.9458240000000000 O2-
    0.0056700000000000    0.1001620000000000    0.0541760000000000 O2-
    0.4863280000000000    0.7726720000000000    0.3070230000000000 O2-
    0.3884590000000000    0.9447930000000000    0.9708250000000000 O2-
    0.0057550000000000    0.9047290000000001    0.4398150000000001 O2-
    0.5136720000000001    0.2273280000000000    0.6929770000000000 O2-""",
    )
    assert compare_data_poscar(
        dataset[8644],
        """Ti4 H32 O12 F24
    1.0
    6.6735670000000002    0.0000000000000000    0.0000000000000004
    0.0000000000000013    8.2892360000000007    0.0000000000000005
    0.0000000000000000    0.0000000000000000   13.1427870000000002
    Ti H O F
    4 32 12 24
    direct
    0.3631120000000000    0.7501110000000000    0.3187530000000000 Ti4+
    0.1368880000000000    0.7501110000000000    0.8187530000000000 Ti4+
    0.6368880000000000    0.2501110000000000    0.6812470000000000 Ti4+
    0.8631120000000000    0.2501110000000000    0.1812470000000000 Ti4+
    0.4295290000000000    0.1036580000000000    0.1181780000000000 H+
    0.0625139999999997    0.4023900000000000    0.6129570000000000 H+
    0.5704710000000000    0.6036580000000000    0.8818220000000000 H+
    0.9374860000000003    0.9023900000000000    0.3870430000000000 H+
    0.5625139999999997    0.9023900000000000    0.8870430000000000 H+
    0.9295290000000000    0.6036580000000000    0.3818220000000000 H+
    0.4374860000000003    0.4023900000000000    0.1129570000000000 H+
    0.0704710000000000    0.1036580000000000    0.6181780000000000 H+
    0.3435240000000001    0.9207179999999999    0.1105580000000000 H+
    0.1460929999999998    0.5838840000000000    0.6029169999999999 H+
    0.6564759999999999    0.4207179999999999    0.8894420000000000 H+
    0.8539070000000002    0.0838839999999998    0.3970830000000001 H+
    0.6460929999999998    0.0838839999999998    0.8970830000000001 H+
    0.8435240000000001    0.4207179999999999    0.3894420000000000 H+
    0.3539070000000002    0.5838840000000000    0.1029169999999999 H+
    0.1564759999999999    0.9207179999999999    0.6105580000000000 H+
    0.4428029999999999    0.2511010000000000    0.4563450000000000 H+
    0.0571970000000001    0.2511010000000000    0.9563450000000000 H+
    0.5571970000000001    0.7511010000000000    0.5436550000000000 H+
    0.9428029999999999    0.7511010000000000    0.0436550000000000 H+
    0.3446049999999999    0.1473650000000000    0.3588330000000000 H+
    0.1550209999999997    0.3533569999999999    0.8580620000000000 H+
    0.6553950000000001    0.6473650000000000    0.6411670000000000 H+
    0.8449790000000003    0.8533569999999999    0.1419380000000000 H+
    0.6550209999999997    0.8533569999999999    0.6419380000000000 H+
    0.8446049999999999    0.6473650000000000    0.1411670000000000 H+
    0.3449790000000003    0.3533569999999999    0.3580619999999999 H+
    0.1553950000000001    0.1473650000000000    0.8588330000000000 H+
    0.4884060000000000    0.0021390000000001    0.0052630000000000 H+
    0.5115940000000000    0.5021390000000001    0.9947370000000000 H+
    0.9884060000000000    0.5021390000000001    0.4947370000000000 H+
    0.0115940000000000    0.0021390000000001    0.5052630000000000 H+
    0.3715309999999999    0.0212790000000000    0.0710190000000001 O2-
    0.1153719999999998    0.4835660000000002    0.5642750000000001 O2-
    0.6284690000000001    0.5212790000000000    0.9289809999999999 O2-
    0.8846280000000002    0.9835660000000002    0.4357249999999999 O2-
    0.6153719999999998    0.9835660000000002    0.9357249999999999 O2-
    0.8715309999999999    0.5212790000000000    0.4289809999999999 O2-
    0.3846280000000002    0.4835660000000002    0.0642750000000001 O2-
    0.1284690000000001    0.0212790000000000    0.5710190000000001 O2-
    0.3370589999999999    0.2508029999999999    0.4004330000000000 O2-
    0.1629410000000001    0.2508029999999999    0.9004330000000000 O2-
    0.6629410000000001    0.7508029999999999    0.5995670000000000 O2-
    0.8370589999999999    0.7508029999999999    0.0995670000000000 O2-
    0.3103580000000000    0.7526680000000000    0.1729340000000000 F-
    0.1896420000000000    0.7526680000000000    0.6729340000000000 F-
    0.6896420000000000    0.2526679999999999    0.8270660000000000 F-
    0.8103580000000000    0.2526679999999999    0.3270660000000000 F-
    0.3488180000000000    0.9783260000000000    0.3152980000000000 F-
    0.1484059999999998    0.5224040000000000    0.8136080000000000 F-
    0.6511820000000000    0.4783260000000000    0.6847020000000000 F-
    0.8515940000000002    0.0224039999999999    0.1863920000000000 F-
    0.6484059999999998    0.0224039999999999    0.6863920000000000 F-
    0.8488180000000000    0.4783260000000000    0.1847020000000000 F-
    0.3515940000000002    0.5224040000000000    0.3136079999999999 F-
    0.1511820000000000    0.9783260000000000    0.8152980000000000 F-
    0.0736349999999998    0.7488300000000000    0.3407270000000000 F-
    0.4263650000000002    0.7488300000000000    0.8407270000000000 F-
    0.9263650000000002    0.2488299999999999    0.6592730000000000 F-
    0.5736349999999998    0.2488299999999999    0.1592730000000000 F-
    0.3980359999999999    0.7500530000000001    0.4619380000000000 F-
    0.1019640000000001    0.7500530000000001    0.9619380000000000 F-
    0.6019640000000001    0.2500530000000001    0.5380620000000000 F-
    0.8980359999999999    0.2500530000000001    0.0380620000000000 F-
    0.6306569999999999    0.7513480000000000    0.2957010000000000 F-
    0.8693430000000001    0.7513480000000000    0.7957010000000000 F-
    0.3693430000000001    0.2513480000000001    0.7042990000000000 F-
    0.1306569999999998    0.2513480000000001    0.2042990000000000 F-""",
    )
    assert compare_data_poscar(
        dataset[115773],
        """H48 C8 S8 Br8 N24
    1.0
    7.8387510000000002    0.0000000000000000    0.0000000000000005
    0.0000000000000019   12.0856269999999988    0.0000000000000007
    0.0000000000000000    0.0000000000000000   12.3457210000000028
    H C S Br N
    48 8 8 8 24
    direct
    0.3165900000000000    0.3057349999999999    0.8775269999999997 H+
    0.1834100000000000    0.6942650000000001    0.3775269999999997 H+
    0.8165899999999999    0.1942650000000001    0.1224730000000003 H+
    0.6834100000000001    0.8057349999999999    0.6224730000000003 H+
    0.6834100000000001    0.6942650000000001    0.1224730000000003 H+
    0.8165899999999999    0.3057349999999999    0.6224730000000003 H+
    0.1834100000000000    0.8057349999999999    0.8775269999999997 H+
    0.3165900000000000    0.1942650000000001    0.3775269999999997 H+
    0.4736810000000000    0.3612449999999999    0.0485140000000000 H+
    0.0263190000000000    0.6387550000000001    0.5485139999999999 H+
    0.9736810000000000    0.1387550000000001    0.9514860000000001 H+
    0.5263190000000000    0.8612449999999999    0.4514860000000000 H+
    0.5263190000000000    0.6387550000000001    0.9514860000000001 H+
    0.9736810000000000    0.3612449999999999    0.4514860000000000 H+
    0.0263190000000000    0.8612449999999999    0.0485140000000000 H+
    0.4736810000000000    0.1387550000000001    0.5485139999999999 H+
    0.3803240000000000    0.2349540000000000    0.0313040000000000 H+
    0.1196760000000000    0.7650460000000000    0.5313040000000000 H+
    0.8803240000000000    0.2650460000000000    0.9686960000000000 H+
    0.6196760000000000    0.7349540000000000    0.4686960000000000 H+
    0.6196760000000000    0.7650460000000000    0.9686960000000000 H+
    0.8803240000000000    0.2349540000000000    0.4686960000000000 H+
    0.1196760000000000    0.7349540000000000    0.0313040000000000 H+
    0.3803240000000000    0.2650460000000000    0.5313040000000000 H+
    0.2771620000000000    0.3296029999999999    0.1068950000000000 H+
    0.2228380000000000    0.6703970000000001    0.6068950000000000 H+
    0.7771620000000000    0.1703970000000001    0.8931050000000000 H+
    0.7228380000000000    0.8296029999999999    0.3931050000000000 H+
    0.7228380000000000    0.6703970000000001    0.8931050000000000 H+
    0.7771620000000000    0.3296029999999999    0.3931050000000000 H+
    0.2228380000000000    0.8296029999999999    0.1068950000000000 H+
    0.2771620000000000    0.1703970000000001    0.6068950000000000 H+
    0.1286530000000000    0.5626080000000000    0.8138429999999998 H+
    0.3713470000000000    0.4373920000000000    0.3138429999999999 H+
    0.6286530000000000    0.9373920000000000    0.1861570000000002 H+
    0.8713470000000000    0.0626080000000000    0.6861570000000002 H+
    0.8713470000000000    0.4373920000000000    0.1861570000000002 H+
    0.6286530000000000    0.5626080000000000    0.6861570000000002 H+
    0.3713470000000000    0.0626080000000000    0.8138429999999998 H+
    0.1286530000000000    0.9373920000000000    0.3138429999999999 H+
    0.1385530000000000    0.4216759999999999    0.7770619999999997 H+
    0.3614470000000000    0.5783240000000001    0.2770619999999997 H+
    0.6385530000000000    0.0783240000000001    0.2229380000000003 H+
    0.8614470000000000    0.9216759999999999    0.7229380000000003 H+
    0.8614470000000000    0.5783240000000001    0.2229380000000003 H+
    0.6385530000000000    0.4216759999999999    0.7229380000000003 H+
    0.3614470000000000    0.9216759999999999    0.7770619999999997 H+
    0.1385530000000000    0.0783240000000001    0.2770619999999997 H+
    0.2328960000000000    0.4613180000000000    0.9274009999999998 C4+
    0.2671040000000000    0.5386820000000001    0.4274009999999997 C4+
    0.7328960000000000    0.0386820000000000    0.0725990000000002 C4+
    0.7671040000000000    0.9613179999999999    0.5725990000000002 C4+
    0.7671040000000000    0.5386820000000001    0.0725990000000002 C4+
    0.7328960000000000    0.4613180000000000    0.5725990000000002 C4+
    0.2671040000000000    0.9613179999999999    0.9274009999999998 C4+
    0.2328960000000000    0.0386820000000000    0.4274009999999997 C4+
    0.2628250000000000    0.5552700000000002    0.0271270000000000 S2-
    0.2371750000000000    0.4447299999999998    0.5271270000000000 S2-
    0.7628250000000000    0.9447299999999998    0.9728730000000000 S2-
    0.7371750000000000    0.0552700000000002    0.4728730000000000 S2-
    0.7371750000000000    0.4447299999999998    0.9728730000000000 S2-
    0.7628250000000000    0.5552700000000002    0.4728730000000000 S2-
    0.2371750000000000    0.0552700000000002    0.0271270000000000 S2-
    0.2628250000000000    0.9447299999999998    0.5271270000000000 S2-
    0.0499590000000000    0.2247720000000000    0.7184959999999999 Br+
    0.4500410000000000    0.7752280000000000    0.2184960000000000 Br+
    0.5499590000000000    0.2752280000000000    0.2815040000000001 Br+
    0.9500410000000000    0.7247720000000000    0.7815040000000001 Br+
    0.9500410000000000    0.7752280000000000    0.2815040000000001 Br+
    0.5499590000000000    0.2247720000000000    0.7815040000000001 Br+
    0.4500410000000000    0.7247720000000000    0.7184959999999999 Br+
    0.0499590000000000    0.2752280000000000    0.2184960000000000 Br+
    0.2701920000000000    0.3509180000000000    0.9430029999999998 N3-
    0.2298080000000000    0.6490820000000000    0.4430029999999998 N3-
    0.7701920000000000    0.1490820000000000    0.0569970000000002 N3-
    0.7298080000000000    0.8509180000000000    0.5569970000000002 N3-
    0.7298080000000000    0.6490820000000000    0.0569970000000002 N3-
    0.7701920000000000    0.3509180000000000    0.5569970000000002 N3-
    0.2298080000000000    0.8509180000000000    0.9430029999999998 N3-
    0.2701920000000000    0.1490820000000000    0.4430029999999998 N3-
    0.3575080000000000    0.3197780000000000    0.0388310000000000 N3-
    0.1424920000000000    0.6802220000000001    0.5388309999999999 N3-
    0.8575079999999999    0.1802220000000000    0.9611690000000001 N3-
    0.6424920000000001    0.8197779999999999    0.4611690000000000 N3-
    0.6424920000000001    0.6802220000000001    0.9611690000000001 N3-
    0.8575079999999999    0.3197780000000000    0.4611690000000000 N3-
    0.1424920000000000    0.8197779999999999    0.0388310000000000 N3-
    0.3575080000000000    0.1802220000000000    0.5388309999999999 N3-
    0.1718810000000000    0.4839399999999999    0.8292359999999998 N3-
    0.3281190000000000    0.5160600000000001    0.3292359999999999 N3-
    0.6718810000000000    0.0160600000000001    0.1707640000000002 N3-
    0.8281190000000000    0.9839399999999999    0.6707640000000002 N3-
    0.8281190000000000    0.5160600000000001    0.1707640000000002 N3-
    0.6718810000000000    0.4839399999999999    0.6707640000000002 N3-
    0.3281190000000000    0.9839399999999999    0.8292359999999998 N3-
    0.1718810000000000    0.0160600000000001    0.3292359999999999 N3-""",
    )
    assert compare_data_poscar(
        dataset[20421],
        """Ba16 In16 O38
    1.0
    0.0000000000000000    8.6502121140609489    0.0000000000000000
    16.7156695400000004    0.0000000000000000    0.0000000000000000
    0.0000000000000000   -0.2425101321650535   -8.5137006484254929
    Ba In O
    16 16 38
    direct
    0.5149427000000001    0.6448828300000000    0.2466201600000000 Ba2+
    0.4932137950000001    0.6373422550000001    0.7582738800000000 Ba2+
    0.4934510900000001    0.8599156900000000    0.2606886000000000 Ba2+
    0.9934510900000002    0.6400843100000000    0.2606886000000000 Ba2+
    0.5117309900000001    0.8614447900000000    0.7479821400000000 Ba2+
    0.0149427000000001    0.8551171700000000    0.2466201600000000 Ba2+
    0.0117309900000001    0.6385552100000000    0.7479821400000000 Ba2+
    0.9932137950000000    0.8626577449999999    0.7582738800000000 Ba2+
    0.0149427000000001    0.1448828300000000    0.2466201600000000 Ba2+
    0.9932137950000000    0.1373422550000001    0.7582738800000000 Ba2+
    0.9934510900000002    0.3599156900000000    0.2606886000000000 Ba2+
    0.4934510900000002    0.1400843100000000    0.2606886000000000 Ba2+
    0.0117309900000001    0.3614447900000000    0.7479821400000000 Ba2+
    0.5149427000000002    0.3551171700000000    0.2466201600000000 Ba2+
    0.5117309900000002    0.1385552100000000    0.7479821400000000 Ba2+
    0.4932137950000000    0.3626577449999999    0.7582738800000000 Ba2+
    0.7430619400000000    0.0000000000000000    0.0895622400000000 In2+
    0.7949842100000000    0.0000000000000000    0.4444879000000000 In2+
    0.2430619400000000    0.5000000000000000    0.0895622400000000 In2+
    0.2949842100000000    0.5000000000000000    0.4444879000000000 In2+
    0.2515667050000001    0.7478410650000000    0.0010213900000000 In3+
    0.2510683300000001    0.7478160500000000    0.5029921200000000 In3+
    0.7515667050000001    0.7521589350000000    0.0010213900000000 In3+
    0.7510683300000001    0.7521839500000000    0.5029921200000000 In3+
    0.2331445600000001    0.0000000000000000    0.5394877100000000 In3+
    0.2942715400000001    0.0000000000000000    0.9847056800000000 In3+
    0.7515667050000001    0.2478410650000000    0.0010213900000000 In3+
    0.7510683300000001    0.2478160500000000    0.5029921200000000 In3+
    0.2515667050000001    0.2521589350000000    0.0010213900000000 In3+
    0.2510683300000001    0.2521839500000000    0.5029921200000000 In3+
    0.7331445599999999    0.5000000000000000    0.5394877100000000 In3+
    0.7942715400000000    0.5000000000000000    0.9847056800000000 In3+
    0.2536233250000002    0.7427458450000000    0.2515534500000000 O2-
    0.5008569500000001    0.7421201500000000    0.5058752700000000 O2-
    0.7536233250000002    0.7572541550000000    0.2515534500000000 O2-
    0.5012163400000001    0.7586801800000000    0.0060984900000000 O2-
    0.0012163400000001    0.7413198200000000    0.0060984900000000 O2-
    0.5008934700000001    0.0000000000000000    0.1143116700000000 O2-
    0.2109441950000002    0.8869026650000000    0.0181755800000000 O2-
    0.7109441950000002    0.6130973350000000    0.0181755800000000 O2-
    0.2163708000000002    0.6121853500000001    0.5175731800000001 O2-
    0.7163708000000002    0.8878146499999999    0.5175731800000001 O2-
    0.7744552250000001    0.8896151450000001    0.9790562900000001 O2-
    0.2744552250000001    0.6103848549999999    0.9790562900000001 O2-
    0.7671396950000000    0.6142993649999999    0.4629237500000000 O2-
    0.2671396950000000    0.8857006350000001    0.4629237500000000 O2-
    0.3592376900000002    0.0000000000000000    0.7513186900000000 O2-
    0.2553100550000001    0.7567268350000000    0.7523353200000000 O2-
    0.7553100550000003    0.7432731650000000    0.7523353200000000 O2-
    0.0008569500000001    0.7578798500000000    0.5058752700000000 O2-
    0.9986041700000000    0.0000000000000000    0.5870538700000000 O2-
    0.7536233250000002    0.2427458450000000    0.2515534500000000 O2-
    0.0008569500000001    0.2421201500000000    0.5058752700000000 O2-
    0.2536233250000002    0.2572541550000000    0.2515534500000000 O2-
    0.0012163400000001    0.2586801800000000    0.0060984900000000 O2-
    0.5012163400000000    0.2413198200000000    0.0060984900000000 O2-
    0.0008934700000001    0.5000000000000000    0.1143116700000000 O2-
    0.7109441950000002    0.3869026650000000    0.0181755800000000 O2-
    0.2109441950000002    0.1130973350000000    0.0181755800000000 O2-
    0.7163708000000002    0.1121853500000001    0.5175731800000001 O2-
    0.2163708000000002    0.3878146499999999    0.5175731800000001 O2-
    0.2744552250000001    0.3896151450000001    0.9790562900000001 O2-
    0.7744552250000001    0.1103848549999999    0.9790562900000001 O2-
    0.2671396950000000    0.1142993649999999    0.4629237500000000 O2-
    0.7671396950000000    0.3857006350000001    0.4629237500000000 O2-
    0.8592376900000001    0.5000000000000000    0.7513186900000000 O2-
    0.7553100550000003    0.2567268350000000    0.7523353200000000 O2-
    0.2553100550000003    0.2432731650000000    0.7523353200000000 O2-
    0.5008569500000002    0.2578798500000000    0.5058752700000000 O2-
    0.4986041700000000    0.5000000000000000    0.5870538700000000 O2-""",
    )
    assert compare_data_poscar(
        dataset[-1],
        """Mg4 Sb8
    1.0
    0.0000000000000000   11.2198159999999998    0.0000000000000000
    4.3429399999999996    0.0000000000000000    0.0000000000000000
    0.0000000000000000   -2.0732109999999997   -6.7100529999999994
    Mg Sb
    4 8
    direct
    0.6187360000000000    0.0000000000000000    0.7765950000000000 Mg2+
    0.9320040000000001    0.0000000000000000    0.3600170000000000 Mg2+
    0.1187360000000000    0.5000000000000000    0.7765950000000000 Mg2+
    0.4320040000000001    0.5000000000000000    0.3600170000000000 Mg2+
    0.5195710000000000    0.5000000000000000    0.9771570000000001 Sb-
    0.8217250000000000    0.5000000000000000    0.6326820000000000 Sb-
    0.6501050000000000    0.0000000000000000    0.3802450000000001 Sb-
    0.7911920000000000    0.5000000000000000    0.0399710000000000 Sb-
    0.0195710000000000    0.0000000000000000    0.9771570000000001 Sb-
    0.3217250000000000    0.0000000000000000    0.6326820000000000 Sb-
    0.1501050000000000    0.5000000000000000    0.3802450000000001 Sb-
    0.2911920000000000    0.0000000000000000    0.0399710000000000 Sb-""",
    )
